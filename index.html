<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="AI Chat" />
<meta name="theme-color" content="#f06292" />
<link rel="manifest" href="manifest.json" />
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'><rect fill='%23f06292' width='200' height='200' rx='40'/><text x='100' y='130' font-size='100' text-anchor='middle' fill='white'>ğŸŒ¸</text></svg>" />
<title>âœ¿ AI Chat</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,400;0,500;0,600;0,700;1,400&family=Zen+Maru+Gothic:wght@400;500&display=swap" rel="stylesheet" />
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:         #fff8f9;
  --surface:    #ffffff;
  --surface2:   #fff0f3;
  --border:     #fcd8e0;
  --border-hi:  #f8b4c4;
  --text:       #4a3040;
  --text-dim:   #9a7a88;
  --text-mute:  #d4b0bc;
  --accent:     #f06292;
  --accent-soft:#f8bbd0;
  --accent-lo:  rgba(240,98,146,.08);
  --accent-mid: rgba(240,98,146,.18);
  --petal1:     #fce4ec;
  --petal2:     #ffd6e4;
  --green:      #81c784;
  --red:        #e57373;
  --radius:     16px;
  --radius-sm:  10px;
}

html, body { height: 100%; background: var(--bg); color: var(--text); font-family: 'Nunito', sans-serif; font-size: 14.5px; line-height: 1.65; overflow: hidden; }

body::before {
  content: ''; position: fixed; inset: 0; z-index: 0; pointer-events: none;
  background-image:
    radial-gradient(circle at 15% 20%, rgba(252,200,215,.35) 0%, transparent 40%),
    radial-gradient(circle at 85% 80%, rgba(248,187,208,.3) 0%, transparent 40%),
    radial-gradient(circle at 50% 50%, rgba(255,240,245,.5) 0%, transparent 60%);
}

#app { display: flex; height: 100vh; position: relative; z-index: 1; }

/* â”€â”€ Sidebar â”€â”€ */
#sidebar { width: 250px; min-width: 250px; background: var(--surface); border-right: 1.5px solid var(--border); display: flex; flex-direction: column; overflow: hidden; box-shadow: 2px 0 16px rgba(240,98,146,.06); transition: transform .3s ease; }

/* Mobile hamburger menu */
#menu-toggle { display: none; background: none; border: none; padding: 8px; cursor: pointer; color: var(--accent); font-size: 20px; }

/* Mobile sidebar overlay */
#sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.4); z-index: 999; }

@media (max-width: 768px) {
  #sidebar { 
    position: fixed; 
    left: 0; 
    top: 0; 
    bottom: 0; 
    z-index: 1000; 
    transform: translateX(-100%);
    box-shadow: 4px 0 20px rgba(0,0,0,.15);
  }
  
  #sidebar.open { transform: translateX(0); }
  #sidebar-overlay.show { display: block; }
  #menu-toggle { display: block; }
  
  #topbar { padding: 10px 12px; }
  #session-title { font-size: 13px; min-width: 80px; }
  .topbar-btn { padding: 5px 9px; font-size: 11px; }
  #model-badge, #cost-badge { font-size: 10px; padding: 2px 8px; }
  
  #messages { padding: 20px 0; }
  .message { padding: 0 14px; }
  .bubble { max-width: 90%; font-size: 13.5px; padding: 10px 14px; }
  
  #input-bar { padding: 10px; gap: 8px; }
  #user-input { font-size: 14px; padding: 10px 12px; }
  #send-btn { padding: 10px 16px; font-size: 13px; }
}

.sidebar-head { padding: 22px 18px 14px; border-bottom: 1.5px solid var(--border); }
.app-logo { font-family: 'Zen Maru Gothic', sans-serif; font-size: 18px; color: var(--accent); letter-spacing: .03em; line-height: 1; }
.app-logo span { color: var(--text-dim); font-size: 12px; font-family: 'Nunito', sans-serif; display: block; margin-top: 3px; }

.btn-new { margin: 12px 12px 6px; padding: 10px 14px; background: linear-gradient(135deg, #f48fb1, #f06292); border: none; border-radius: var(--radius); color: #fff; font-family: 'Nunito', sans-serif; font-size: 13.5px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all .2s; box-shadow: 0 3px 12px rgba(240,98,146,.3); }
.btn-new:hover { transform: translateY(-1px); box-shadow: 0 5px 16px rgba(240,98,146,.4); }

.sessions-list { flex: 1; overflow-y: auto; padding: 6px 10px; }
.sessions-list::-webkit-scrollbar { width: 4px; }
.sessions-list::-webkit-scrollbar-thumb { background: var(--accent-soft); border-radius: 4px; }

.session-item { display: flex; align-items: center; gap: 8px; padding: 9px 10px; border-radius: var(--radius-sm); cursor: pointer; transition: all .15s; border: 1.5px solid transparent; }
.session-item:hover { background: var(--petal1); }
.session-item.active { background: var(--petal2); border-color: var(--border); }
.session-item.active .session-name { color: var(--accent); font-weight: 600; }
.session-icon { color: var(--text-mute); flex-shrink: 0; }
.session-item.active .session-icon { color: var(--accent-soft); }
.session-name { flex: 1; font-size: 13px; color: var(--text-dim); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.session-del { opacity: 0; background: none; border: none; color: var(--text-mute); cursor: pointer; padding: 2px 4px; border-radius: 6px; transition: all .15s; }
.session-item:hover .session-del { opacity: 1; }
.session-del:hover { color: var(--red); background: rgba(229,115,115,.1); }

.sidebar-foot { padding: 12px; border-top: 1.5px solid var(--border); display: flex; flex-direction: column; gap: 7px; }
.btn-settings { width: 100%; padding: 9px 12px; background: var(--surface2); border: 1.5px solid var(--border); border-radius: var(--radius-sm); color: var(--text-dim); font-family: 'Nunito', sans-serif; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all .18s; }
.btn-settings:hover { border-color: var(--accent-soft); color: var(--accent); background: var(--accent-lo); }

/* â”€â”€ Main â”€â”€ */
#main { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-width: 0; }

/* â”€â”€ Topbar â”€â”€ */
#topbar { padding: 12px 20px; border-bottom: 1.5px solid var(--border); display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,.85); backdrop-filter: blur(12px); flex-wrap: wrap; }
#session-title { font-size: 14.5px; font-weight: 700; color: var(--text); background: none; border: none; outline: none; font-family: 'Nunito', sans-serif; flex: 1; min-width: 120px; }
#session-title:hover { color: var(--accent); }
#model-badge { font-size: 11px; font-weight: 700; color: var(--accent); background: var(--accent-lo); border: 1.5px solid var(--accent-soft); border-radius: 20px; padding: 3px 10px; flex-shrink: 0; }

/* cost badge */
#cost-badge { font-size: 11px; font-weight: 700; color: var(--text-dim); background: var(--surface2); border: 1.5px solid var(--border); border-radius: 20px; padding: 3px 10px; flex-shrink: 0; cursor: help; }

.topbar-btn { display: flex; align-items: center; gap: 5px; padding: 6px 11px; background: var(--surface2); border: 1.5px solid var(--border); border-radius: 20px; color: var(--text-dim); font-family: 'Nunito', sans-serif; font-size: 12px; font-weight: 600; cursor: pointer; transition: all .18s; flex-shrink: 0; }
.topbar-btn:hover { border-color: var(--accent-soft); color: var(--accent); }
.topbar-btn.active { border-color: var(--accent); color: var(--accent); background: var(--accent-lo); }

/* context info bar */
#context-bar { padding: 5px 20px; background: var(--petal1); border-bottom: 1px solid var(--border); font-size: 11.5px; color: var(--text-dim); display: flex; align-items: center; gap: 8px; }
#context-bar span { font-weight: 700; color: var(--accent); }

/* â”€â”€ Messages â”€â”€ */
#messages { flex: 1; overflow-y: auto; padding: 28px 0; scroll-behavior: smooth; }
#messages::-webkit-scrollbar { width: 5px; }
#messages::-webkit-scrollbar-thumb { background: var(--accent-soft); border-radius: 10px; }

.message { max-width: 740px; margin: 0 auto 6px; padding: 0 22px; animation: msgIn .22s ease both; }
@keyframes msgIn { from { opacity: 0; transform: translateY(7px); } to { opacity: 1; transform: translateY(0); } }

.msg-inner { display: flex; gap: 10px; align-items: flex-start; }
.msg-inner.user-inner { flex-direction: row-reverse; }

.avatar { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; margin-top: 2px; }
.avatar-user { background: linear-gradient(135deg, #f48fb1, #f06292); box-shadow: 0 2px 8px rgba(240,98,146,.3); }
.avatar-ai { background: var(--petal1); border: 1.5px solid var(--border); }

.bubble { max-width: 78%; padding: 12px 16px; border-radius: var(--radius); font-size: 14px; line-height: 1.75; word-break: break-word; }
.bubble-user { background: linear-gradient(135deg, #f48fb1, #f06292); color: #fff; border-radius: var(--radius) 4px var(--radius) var(--radius); box-shadow: 0 3px 12px rgba(240,98,146,.25); white-space: pre-wrap; }
.bubble-ai { background: var(--surface); border: 1.5px solid var(--border); border-radius: 4px var(--radius) var(--radius) var(--radius); box-shadow: 0 2px 8px rgba(200,100,130,.06); }

.bubble-user code { background: rgba(255,255,255,.25); border: none; padding: 1px 6px; border-radius: 5px; font-family: monospace; color: #fff; font-size: 13px; }
.bubble-ai code { font-family: monospace; font-size: 12.5px; background: var(--petal1); border: 1px solid var(--border); border-radius: 5px; padding: 1px 6px; color: var(--accent); }
.bubble pre { background: var(--petal1); border: 1.5px solid var(--border); border-radius: var(--radius-sm); padding: 14px; overflow-x: auto; margin: 8px 0; }
.bubble pre code { background: none; border: none; padding: 0; color: var(--text); font-size: 13px; }
.bubble strong { font-weight: 700; }
.bubble em { font-style: italic; }
.bubble p { margin-bottom: 8px; }
.bubble p:last-child { margin-bottom: 0; }
.bubble ul, .bubble ol { padding-left: 20px; margin: 6px 0; }
.bubble li { margin-bottom: 3px; }
.bubble h1,.bubble h2,.bubble h3 { font-family: 'Zen Maru Gothic', sans-serif; color: var(--accent); margin: 12px 0 6px; }

.cursor-blink::after { content: 'â™¥'; animation: blink .8s step-end infinite; color: var(--accent); font-size: 12px; }
@keyframes blink { 0%,100%{opacity:1}50%{opacity:0} }

/* empty */
#empty-state { max-width: 440px; margin: auto; text-align: center; padding: 60px 24px; }
#empty-state .petals { font-size: 48px; margin-bottom: 16px; animation: float 3s ease-in-out infinite; }
@keyframes float { 0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)} }
#empty-state h2 { font-family: 'Zen Maru Gothic', sans-serif; font-size: 28px; color: var(--accent); margin-bottom: 10px; }
#empty-state p { color: var(--text-dim); font-size: 13.5px; line-height: 1.9; }

/* â”€â”€ Input â”€â”€ */
#input-area { padding: 14px 22px 20px; border-top: 1.5px solid var(--border); background: rgba(255,255,255,.85); backdrop-filter: blur(12px); }
#input-wrap { max-width: 740px; margin: 0 auto; background: var(--surface); border: 2px solid var(--border); border-radius: 24px; display: flex; align-items: flex-end; transition: border-color .2s, box-shadow .2s; box-shadow: 0 2px 12px rgba(240,98,146,.06); }
#input-wrap:focus-within { border-color: var(--accent-soft); box-shadow: 0 4px 20px rgba(240,98,146,.12); }
#user-input { flex: 1; background: transparent; border: none; font-family: 'Nunito', sans-serif; font-size: 14px; color: var(--text); padding: 14px 16px; resize: none; min-height: 52px; max-height: 180px; overflow-y: auto; outline: none; line-height: 1.6; }
#user-input::placeholder { color: var(--text-mute); }

.input-btn { width: 38px; height: 38px; margin: 7px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all .2s; }
#send-btn { background: linear-gradient(135deg, #f48fb1, #f06292); box-shadow: 0 2px 10px rgba(240,98,146,.35); }
#send-btn svg { color: #fff; }
#send-btn:hover:not(:disabled) { transform: scale(1.08) rotate(10deg); box-shadow: 0 4px 16px rgba(240,98,146,.5); }
#send-btn:disabled { opacity: .4; cursor: not-allowed; transform: none; }
#stop-btn { background: var(--petal1); border: 1.5px solid var(--border); color: var(--red); display: none; }
#stop-btn.show { display: flex; }
#stop-btn:hover { border-color: var(--red); }

.hint { max-width: 740px; margin: 7px auto 0; font-size: 11.5px; color: var(--text-mute); text-align: center; }

/* â”€â”€ Memory panel â”€â”€ */
#memory-panel { width: 310px; min-width: 310px; background: var(--surface); border-left: 1.5px solid var(--border); display: flex; flex-direction: column; transform: translateX(100%); transition: transform .28s cubic-bezier(.4,0,.2,1); position: absolute; right: 0; top: 0; bottom: 0; z-index: 10; box-shadow: -4px 0 24px rgba(240,98,146,.08); }
#memory-panel.open { transform: translateX(0); position: relative; }

.mem-head { padding: 16px; border-bottom: 1.5px solid var(--border); display: flex; align-items: center; gap: 10px; background: var(--petal1); }
.mem-title { font-size: 14px; font-weight: 700; flex: 1; color: var(--accent); }
.mem-close { background: var(--surface); border: 1.5px solid var(--border); color: var(--text-mute); cursor: pointer; padding: 5px; border-radius: 50%; transition: all .15s; display: flex; align-items: center; justify-content: center; }
.mem-close:hover { color: var(--accent); border-color: var(--accent-soft); }

.mem-tabs { display: flex; border-bottom: 1.5px solid var(--border); }
.mem-tab { flex: 1; padding: 10px; text-align: center; font-size: 12.5px; font-weight: 700; color: var(--text-dim); cursor: pointer; border-bottom: 2.5px solid transparent; transition: all .15s; background: none; border-top: none; border-left: none; border-right: none; font-family: 'Nunito', sans-serif; }
.mem-tab.active { color: var(--accent); border-bottom-color: var(--accent); background: var(--accent-lo); }

.mem-pane { display: none; flex: 1; flex-direction: column; overflow: hidden; }
.mem-pane.active { display: flex; }

.mem-section { padding: 14px; border-bottom: 1.5px solid var(--border); }
.mem-label { font-size: 11px; font-weight: 700; letter-spacing: .1em; text-transform: uppercase; color: var(--text-dim); margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; }

#manual-memory { width: 100%; height: 100px; resize: none; background: var(--bg); border: 1.5px solid var(--border); border-radius: var(--radius-sm); color: var(--text); font-family: 'Nunito', sans-serif; font-size: 13px; padding: 10px 12px; outline: none; transition: border-color .2s; line-height: 1.6; }
#manual-memory:focus { border-color: var(--accent-soft); }
#manual-memory::placeholder { color: var(--text-mute); }
.mem-note { font-size: 11.5px; color: var(--text-dim); margin-top: 8px; line-height: 1.6; }

.mem-scroll { flex: 1; overflow-y: auto; padding: 10px 14px; }
.mem-scroll::-webkit-scrollbar { width: 4px; }
.mem-scroll::-webkit-scrollbar-thumb { background: var(--accent-soft); border-radius: 4px; }

#auto-memories { display: flex; flex-direction: column; gap: 6px; }

.mem-item { display: flex; align-items: flex-start; gap: 8px; padding: 9px 10px; background: var(--petal1); border: 1.5px solid var(--border); border-radius: var(--radius-sm); font-size: 12.5px; line-height: 1.55; animation: msgIn .2s ease both; }
.mem-item-text { flex: 1; color: var(--text-dim); }
.mem-item-del { background: none; border: none; color: var(--text-mute); cursor: pointer; padding: 1px; flex-shrink: 0; opacity: 0; transition: opacity .15s; }
.mem-item:hover .mem-item-del { opacity: 1; }
.mem-item-del:hover { color: var(--red); }
.mem-empty { font-size: 13px; color: var(--text-mute); text-align: center; padding: 24px 0; }

.mem-actions { padding: 12px 14px; display: flex; flex-direction: column; gap: 8px; border-top: 1.5px solid var(--border); }

.btn-mem { width: 100%; padding: 9px; border-radius: var(--radius-sm); font-family: 'Nunito', sans-serif; font-size: 12.5px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: all .18s; }
.btn-extract { background: linear-gradient(135deg, #fce4ec, #ffd6e4); border: 1.5px solid var(--accent-soft); color: var(--accent); }
.btn-extract:hover { background: var(--petal2); }
.btn-compress { background: linear-gradient(135deg, #fce4ec, #f8bbd0); border: 1.5px solid var(--border-hi); color: #e91e8c; }
.btn-compress:hover { background: var(--petal2); }
.btn-mem:disabled { opacity: .4; cursor: not-allowed; }

.mem-backup-row { display: flex; gap: 6px; }
.btn-backup { flex: 1; padding: 8px; background: var(--surface2); border: 1.5px solid var(--border); border-radius: var(--radius-sm); color: var(--text-dim); font-family: 'Nunito', sans-serif; font-size: 12px; font-weight: 600; cursor: pointer; transition: all .18s; }
.btn-backup:hover { border-color: var(--accent-soft); color: var(--accent); }

/* mem stats */
.mem-stats { padding: 10px 14px; background: var(--petal1); border-bottom: 1.5px solid var(--border); font-size: 12px; color: var(--text-dim); display: flex; gap: 12px; }
.mem-stat { display: flex; align-items: center; gap: 4px; }
.mem-stat strong { color: var(--accent); }

/* â”€â”€ Settings modal â”€â”€ */
#settings-overlay { position: fixed; inset: 0; background: rgba(200,100,140,.15); display: none; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(6px); }
#settings-overlay.open { display: flex; }
#settings-modal { background: var(--surface); border: 1.5px solid var(--border); border-radius: 20px; width: 440px; max-width: 95vw; max-height: 92vh; overflow-y: auto; padding: 28px; display: flex; flex-direction: column; gap: 18px; animation: modalIn .22s ease; box-shadow: 0 12px 48px rgba(240,98,146,.15); }
@keyframes modalIn { from { opacity:0; transform:scale(.95) translateY(8px); } to { opacity:1; transform:scale(1) translateY(0); } }
.modal-title { font-family: 'Zen Maru Gothic', sans-serif; font-size: 20px; color: var(--accent); }
.modal-section-title { font-size: 12px; font-weight: 700; letter-spacing: .08em; text-transform: uppercase; color: var(--text-dim); padding-bottom: 10px; border-bottom: 1.5px solid var(--border); }

.field-group { display: flex; flex-direction: column; gap: 7px; }
.field-label { font-size: 11px; font-weight: 700; letter-spacing: .1em; text-transform: uppercase; color: var(--text-dim); }
.field-hint { font-size: 11.5px; color: var(--text-mute); margin-top: 4px; }

input[type="password"], input[type="text"], select, textarea {
  background: var(--bg); border: 1.5px solid var(--border); border-radius: var(--radius-sm); color: var(--text); font-family: 'Nunito', sans-serif; font-size: 13.5px; padding: 10px 12px; outline: none; width: 100%; transition: border-color .2s;
}
input[type="password"]:focus, input[type="text"]:focus, select:focus, textarea:focus { border-color: var(--accent-soft); box-shadow: 0 0 0 3px rgba(240,98,146,.08); }
select { cursor: pointer; -webkit-appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%23d4b0bc'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 28px; }
#sys-prompt { resize: none; height: 80px; line-height: 1.6; }

.modal-actions { display: flex; gap: 10px; justify-content: flex-end; }
.btn-primary { padding: 10px 22px; background: linear-gradient(135deg, #f48fb1, #f06292); color: #fff; border: none; border-radius: 20px; font-family: 'Nunito', sans-serif; font-size: 13.5px; font-weight: 700; cursor: pointer; transition: all .18s; box-shadow: 0 3px 12px rgba(240,98,146,.3); }
.btn-primary:hover { transform: translateY(-1px); box-shadow: 0 5px 16px rgba(240,98,146,.4); }
.btn-secondary { padding: 10px 16px; background: var(--surface2); border: 1.5px solid var(--border); border-radius: 20px; color: var(--text-dim); font-family: 'Nunito', sans-serif; font-size: 13.5px; font-weight: 600; cursor: pointer; transition: all .18s; }
.btn-secondary:hover { border-color: var(--accent-soft); color: var(--accent); }

/* â”€â”€ Toast â”€â”€ */
#toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(16px); background: var(--surface); border: 1.5px solid var(--border); color: var(--text); font-size: 13px; font-weight: 600; padding: 10px 20px; border-radius: 20px; opacity: 0; transition: all .3s; pointer-events: none; z-index: 999; box-shadow: 0 4px 20px rgba(240,98,146,.15); }
#toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
#toast.error { background: var(--red); border-color: var(--red); color: #fff; }

/* hidden file input */
#import-input { display: none; }

@media (max-width: 600px) {
  #sidebar { display: none; }
  #memory-panel { position: fixed; width: 92vw; }
}
</style>
</head>
<body>
<div id="app">

  <!-- Mobile sidebar overlay -->
  <div id="sidebar-overlay" onclick="toggleSidebar()"></div>

  <!-- â”€â”€ Sidebar â”€â”€ -->
  <aside id="sidebar">
    <div class="sidebar-head">
      <div class="app-logo">
        âœ¿ AI Chat
        <span>ä½ çš„ä¸“å±å¯¹è¯ç©ºé—´</span>
      </div>
    </div>

    <button class="btn-new" onclick="newSession()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      æ–°å¯¹è¯
    </button>

    <div class="sessions-list" id="sessions-list"></div>

    <div class="sidebar-foot">
      <button class="btn-settings" onclick="openSettings()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
        è®¾ç½® API Key Â· æ¨¡å‹
      </button>
    </div>
  </aside>

  <!-- â”€â”€ Main â”€â”€ -->
  <main id="main">
    <div id="topbar">
      <button id="menu-toggle" onclick="toggleSidebar()" aria-label="æ‰“å¼€èœå•">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
          <line x1="3" y1="6" x2="21" y2="6"/>
          <line x1="3" y1="12" x2="21" y2="12"/>
          <line x1="3" y1="18" x2="21" y2="18"/>
        </svg>
      </button>
      <input id="session-title" value="æ–°å¯¹è¯" onblur="renameSession(this.value)" onkeydown="if(event.key==='Enter')this.blur()" />
      <span id="model-badge">gpt-4o</span>
      <span id="cost-badge" title="æœ¬æ¬¡å¯¹è¯é¢„ä¼°èŠ±è´¹ï¼ˆç²—ç•¥ä¼°ç®—ï¼‰">ğŸ’° $0.000</span>
      <button class="topbar-btn" id="mem-toggle" onclick="toggleMemory()">ğŸŒ¸ è®°å¿†åº“</button>
      <button class="topbar-btn" onclick="exportChat()">ğŸ’¾ å¯¼å‡º</button>
    </div>

    <div id="context-bar">
      å‘é€æ¶ˆæ¯æ—¶æºå¸¦æœ€è¿‘ <span id="ctx-display">20</span> æ¡å†å² Â· è®°å¿† <span id="mem-count-display">0</span> æ¡
      <span style="margin-left:auto;cursor:pointer;color:var(--accent-soft)" onclick="openSettings()">è°ƒæ•´ â€º</span>
    </div>

    <div id="messages">
      <div id="empty-state">
        <div class="petals">ğŸŒ¸</div>
        <h2>ä½ å¥½å‘€ï½</h2>
        <p>å…ˆç‚¹å·¦ä¸‹è§’å¡«å…¥ API Key<br/>ç„¶åè·Ÿæˆ‘è¯´è¯´è¯å§ â™¡</p>
      </div>
    </div>

    <div id="input-area">
      <div id="input-wrap">
        <textarea id="user-input" placeholder="è¯´ç‚¹ä»€ä¹ˆå§ï½" rows="1"></textarea>
        <button class="input-btn" id="send-btn" onclick="sendMessage()">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
        </button>
        <button class="input-btn" id="stop-btn" onclick="stopGeneration()">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><rect x="4" y="4" width="16" height="16" rx="3"/></svg>
        </button>
      </div>
      <p class="hint">Enter å‘é€ Â· Shift+Enter æ¢è¡Œ âœ¿</p>
    </div>
  </main>

  <!-- â”€â”€ Memory panel â”€â”€ -->
  <div id="memory-panel">
    <div class="mem-head">
      <span>ğŸŒ¸</span>
      <span class="mem-title">æˆ‘çš„è®°å¿†åº“</span>
      <button class="mem-close" onclick="toggleMemory()">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>

    <div class="mem-tabs">
      <button class="mem-tab active" onclick="switchMemTab('manual')">âœï¸ æ‰‹åŠ¨ç¬”è®°</button>
      <button class="mem-tab" onclick="switchMemTab('auto')">âœ¨ AI è®°å¿†</button>
    </div>

    <!-- æ‰‹åŠ¨ç¬”è®° pane -->
    <div class="mem-pane active" id="pane-manual">
      <div class="mem-section" style="flex:1;display:flex;flex-direction:column;gap:8px;overflow:hidden;">
        <div class="mem-label">å…³äºè‡ªå·±çš„ä¿¡æ¯</div>
        <textarea id="manual-memory" style="flex:1;min-height:120px;max-height:none;resize:none;" placeholder="æ¯”å¦‚ï¼šæˆ‘å«å°æ˜ï¼Œå–œæ¬¢çŒ«çŒ«ï¼Œæ­£åœ¨å­¦ Pythonâ€¦"></textarea>
        <p class="mem-note">ğŸ’¡ è¿™é‡Œå†™çš„å†…å®¹ä¼šè‡ªåŠ¨åŠ å…¥æ¯æ¬¡å¯¹è¯å“¦</p>
      </div>
    </div>

    <!-- AI è®°å¿† pane -->
    <div class="mem-pane" id="pane-auto">
      <div class="mem-stats">
        <div class="mem-stat">å…± <strong id="mem-total">0</strong> æ¡</div>
        <div class="mem-stat">çº¦ <strong id="mem-tokens">0</strong> tokens</div>
      </div>
      <div class="mem-scroll">
        <div id="auto-memories">
          <div class="mem-empty">è¿˜æ²¡æœ‰è®°å¿†å‘¢<br/>å¯¹è¯ä¸€ä¼šå„¿è®© AI å¸®ä½ æå–å§ ğŸŒ±</div>
        </div>
      </div>
      <div class="mem-actions">
        <button class="btn-mem btn-extract" id="extract-btn" onclick="extractMemories()">
          âœ¨ ä»å½“å‰å¯¹è¯æå–è®°å¿†
        </button>
        <button class="btn-mem btn-compress" id="compress-btn" onclick="compressMemories()">
          ğŸ—œï¸ å‹ç¼©ç²¾ç®€è®°å¿†åº“
        </button>
        <div class="mem-backup-row">
          <button class="btn-backup" onclick="exportMemories()">ğŸ“¤ å¤‡ä»½è®°å¿†</button>
          <button class="btn-backup" onclick="document.getElementById('import-input').click()">ğŸ“¥ å¯¼å…¥è®°å¿†</button>
        </div>
        <button class="btn-backup" style="width:100%;color:var(--red);border-color:transparent;" onclick="clearAutoMemories()">ğŸ—‘ï¸ æ¸…ç©ºå…¨éƒ¨</button>
      </div>
    </div>
  </div>
</div>

<!-- â”€â”€ Settings modal â”€â”€ -->
<div id="settings-overlay" onclick="if(event.target===this)closeSettings()">
  <div id="settings-modal">
    <div class="modal-title">âš™ï¸ è®¾ç½®</div>

    <div class="modal-section-title">API é…ç½®</div>

    <div class="field-group">
      <div class="field-label">API Key</div>
      <input type="password" id="api-key" placeholder="sk-..." autocomplete="off" />
    </div>

    <div class="field-group">
      <div class="field-label">Base URLï¼ˆå¯é€‰ï¼‰</div>
      <input type="text" id="base-url" placeholder="https://api.openai.com/v1" />
      <div class="field-hint">ç”¨ OpenRouter å¯å¡« https://openrouter.ai/api/v1</div>
    </div>

    <div class="field-group">
      <div class="field-label">æ¨¡å‹</div>
      <select id="model-select">
        <option value="gpt-4o">GPT-4o</option>
        <option value="gpt-4o-mini">GPT-4o mini</option>
        <option value="gpt-4-turbo">GPT-4 Turbo</option>
        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
        <option value="o1">o1</option>
        <option value="o3-mini">o3-mini</option>
      </select>
    </div>

    <div class="modal-section-title">å¯¹è¯è®¾ç½®</div>

    <div class="field-group">
      <div class="field-label">ä¸Šä¸‹æ–‡æ¡æ•°ï¼ˆæ¯æ¬¡å‘é€æœ€è¿‘å‡ æ¡å†å²ï¼‰</div>
      <select id="context-limit">
        <option value="10">æœ€è¿‘ 10 æ¡ï¼ˆæœ€çœé’±ï¼‰</option>
        <option value="20" selected>æœ€è¿‘ 20 æ¡ï¼ˆæ¨èï¼‰</option>
        <option value="40">æœ€è¿‘ 40 æ¡</option>
        <option value="9999">å…¨éƒ¨å†å²ï¼ˆæœ€è´µï¼‰</option>
      </select>
      <div class="field-hint">ğŸ’¡ èŠæ„Ÿæƒ…å»ºè®®é€‰ 20 æ¡ï¼Œå¤ªé•¿çš„å¯¹è¯è¶Šæ¥è¶Šè´µ</div>
    </div>

    <div class="field-group">
      <div class="field-label">Temperature</div>
      <input type="text" id="temperature" value="0.9" placeholder="0.0 â€“ 2.0" />
      <div class="field-hint">èŠæ„Ÿæƒ…å»ºè®® 0.9ï¼Œæ›´æœ‰æƒ…æ„Ÿå’Œå˜åŒ–</div>
    </div>

    <div class="field-group">
      <div class="field-label">é»˜è®¤ System Prompt</div>
      <textarea id="sys-prompt" placeholder="ä½ æ˜¯ä¸€ä¸ªæœ‰å¸®åŠ©çš„ AI åŠ©æ‰‹â€¦"></textarea>
    </div>

    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeSettings()">å–æ¶ˆ</button>
      <button class="btn-primary" onclick="saveSettings()">ä¿å­˜ âœ“</button>
    </div>
  </div>
</div>

<input type="file" id="import-input" accept=".json" onchange="importMemories(event)" />
<div id="toast"></div>

<script>
// â”€â”€â”€ Constants â”€â”€â”€
const K = { sessions:'aichat_sessions', curSession:'aichat_cur', settings:'aichat_settings', manualMem:'aichat_mem_manual', autoMem:'aichat_mem_auto' };

// GPT-4o pricing per 1K tokens (rough estimate)
const PRICE_PER_1K_IN = 0.0025;
const PRICE_PER_1K_OUT = 0.01;

// â”€â”€â”€ State â”€â”€â”€
let settings = { apiKey:'', baseUrl:'', model:'gpt-4o', sysPrompt:'', temperature:'0.9', contextLimit: 20 };
let sessions = [], curId = null, abortCtrl = null, isStreaming = false, autoMemories = [];
let sessionCost = 0; // running cost estimate for current session

// â”€â”€â”€ Init â”€â”€â”€
function init() {
  loadSettings(); loadMemories(); loadSessions();
  if (!sessions.length) newSession(false);
  else switchSession(curId || sessions[0].id);
  renderSessions(); renderAutoMemories(); syncModelBadge();
  updateContextBar();
}

// â”€â”€â”€ Settings â”€â”€â”€
function loadSettings() {
  const s = localStorage.getItem(K.settings);
  if (s) settings = { ...settings, ...JSON.parse(s) };
}
function saveSettings() {
  settings.apiKey      = document.getElementById('api-key').value.trim();
  settings.baseUrl     = document.getElementById('base-url').value.trim();
  settings.model       = document.getElementById('model-select').value;
  settings.sysPrompt   = document.getElementById('sys-prompt').value;
  settings.temperature = document.getElementById('temperature').value;
  settings.contextLimit = parseInt(document.getElementById('context-limit').value);
  localStorage.setItem(K.settings, JSON.stringify(settings));
  syncModelBadge(); updateContextBar(); closeSettings(); showToast('è®¾ç½®å·²ä¿å­˜ âœ“');
}
function openSettings() {
  document.getElementById('api-key').value         = settings.apiKey;
  document.getElementById('base-url').value        = settings.baseUrl;
  document.getElementById('model-select').value    = settings.model;
  document.getElementById('sys-prompt').value      = settings.sysPrompt;
  document.getElementById('temperature').value     = settings.temperature;
  document.getElementById('context-limit').value   = settings.contextLimit;
  document.getElementById('settings-overlay').classList.add('open');
}
function closeSettings() { document.getElementById('settings-overlay').classList.remove('open'); }
function syncModelBadge() { document.getElementById('model-badge').textContent = settings.model; }
function updateContextBar() {
  const limit = settings.contextLimit >= 9999 ? 'å…¨éƒ¨' : settings.contextLimit;
  document.getElementById('ctx-display').textContent = limit;
  document.getElementById('mem-count-display').textContent = autoMemories.length;
}

// â”€â”€â”€ Sessions â”€â”€â”€
function loadSessions() {
  const s = localStorage.getItem(K.sessions);
  sessions = s ? JSON.parse(s) : [];
  curId = localStorage.getItem(K.curSession);
  if (!sessions.find(s => s.id === curId)) curId = sessions[0]?.id || null;
}
function saveSessions() {
  localStorage.setItem(K.sessions, JSON.stringify(sessions));
  localStorage.setItem(K.curSession, curId);
}
function newSession(sw = true) {
  const id = 'sess_' + Date.now();
  sessions.unshift({ id, name:'æ–°å¯¹è¯', messages:[], cost:0, createdAt:Date.now() });
  saveSessions(); renderSessions(); if (sw) { switchSession(id); sessionCost = 0; updateCostBadge(); }
}
function switchSession(id) {
  curId = id; saveSessions(); renderSessions();
  const sess = sessions.find(s => s.id === id); if (!sess) return;
  document.getElementById('session-title').value = sess.name;
  sessionCost = sess.cost || 0;
  updateCostBadge();
  renderMessages(sess.messages);
  // Close sidebar on mobile after switching
  if (window.innerWidth <= 768) {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    sidebar.classList.remove('open');
    overlay.classList.remove('show');
  }
}
function renameSession(name) {
  const sess = sessions.find(s => s.id === curId);
  if (sess) { sess.name = name || 'æ–°å¯¹è¯'; saveSessions(); renderSessions(); }
}
function deleteSession(id, e) {
  e.stopPropagation(); sessions = sessions.filter(s => s.id !== id);
  if (!sessions.length) newSession(false);
  if (curId === id) switchSession(sessions[0].id);
  saveSessions(); renderSessions();
}
function currentSession() { return sessions.find(s => s.id === curId); }
function renderSessions() {
  document.getElementById('sessions-list').innerHTML = sessions.map(s => `
    <div class="session-item ${s.id === curId ? 'active' : ''}" onclick="switchSession('${s.id}')">
      <svg class="session-icon" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
      <span class="session-name">${esc(s.name)}</span>
      <button class="session-del" onclick="deleteSession('${s.id}',event)">
        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>`).join('');
}

// â”€â”€â”€ Cost estimation â”€â”€â”€
function estimateCost(inputText, outputText) {
  const inTokens  = Math.ceil(inputText.length / 3.5);
  const outTokens = Math.ceil(outputText.length / 3.5);
  return (inTokens / 1000 * PRICE_PER_1K_IN) + (outTokens / 1000 * PRICE_PER_1K_OUT);
}
function updateCostBadge() {
  const badge = document.getElementById('cost-badge');
  badge.textContent = `ğŸ’° $${sessionCost.toFixed(4)}`;
  badge.title = `æœ¬æ¬¡å¯¹è¯é¢„ä¼°èŠ±è´¹çº¦ $${sessionCost.toFixed(4)}\nï¼ˆåŸºäº GPT-4o å®šä»·ç²—ç•¥ä¼°ç®—ï¼Œå®é™…ä»¥è´¦å•ä¸ºå‡†ï¼‰`;
}

// â”€â”€â”€ Messages render â”€â”€â”€
function renderMessages(msgs) {
  const el = document.getElementById('messages'); el.innerHTML = '';
  if (!msgs.length) {
    el.innerHTML = '<div id="empty-state"><div class="petals">ğŸŒ¸</div><h2>ä½ å¥½å‘€ï½</h2><p>å…ˆç‚¹å·¦ä¸‹è§’å¡«å…¥ API Key<br/>ç„¶åè·Ÿæˆ‘è¯´è¯´è¯å§ â™¡</p></div>';
    return;
  }
  msgs.forEach(m => { if (m.role==='user'||m.role==='assistant') appendMessageEl(m.role==='user'?'user':'ai', m.content, el); });
  scrollToBottom();
}
function appendMessageEl(role, text, container) {
  const el = container || document.getElementById('messages');
  const wrap = document.createElement('div'); wrap.className = 'message';
  const inner = document.createElement('div'); inner.className = `msg-inner ${role==='user'?'user-inner':''}`;
  const av = document.createElement('div'); av.className = `avatar avatar-${role==='user'?'user':'ai'}`;
  av.textContent = role==='user' ? 'ğŸ°' : 'ğŸŒ¸';
  const bub = document.createElement('div'); bub.className = `bubble bubble-${role==='user'?'user':'ai'}`;
  if (role==='ai') bub.innerHTML = renderMarkdown(text);
  else bub.textContent = text;
  inner.appendChild(av); inner.appendChild(bub);
  wrap.appendChild(inner); el.appendChild(wrap);
  return wrap;
}

function renderMarkdown(text) {
  if (!text) return '';
  let h = esc(text);
  h = h.replace(/```[\w]*\n?([\s\S]*?)```/g, (_,c) => `<pre><code>${c.trim()}</code></pre>`);
  h = h.replace(/`([^`]+)`/g, (_,c) => `<code>${c}</code>`);
  h = h.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  h = h.replace(/\*(.+?)\*/g, '<em>$1</em>');
  h = h.replace(/^### (.+)$/gm, '<h3>$1</h3>');
  h = h.replace(/^## (.+)$/gm, '<h2>$1</h2>');
  h = h.replace(/^# (.+)$/gm, '<h1>$1</h1>');
  h = h.replace(/^[\-\*] (.+)$/gm, '<li>$1</li>');
  h = h.replace(/\n\n+/g, '</p><p>');
  h = h.replace(/\n/g, '<br>');
  if (!h.startsWith('<')) h = '<p>' + h + '</p>';
  return h;
}
function esc(t) { return String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

// â”€â”€â”€ Send message â”€â”€â”€
async function sendMessage() {
  const text = document.getElementById('user-input').value.trim();
  if (!text || isStreaming) return;
  if (!settings.apiKey) { openSettings(); showToast('è¯·å…ˆå¡«å…¥ API Key å“¦ï½', 'error'); return; }

  const sess = currentSession(); if (!sess) return;
  const emp = document.getElementById('empty-state'); if (emp) emp.remove();

  if (!sess.messages.length) {
    sess.name = text.slice(0, 24) + (text.length > 24 ? 'â€¦' : '');
    document.getElementById('session-title').value = sess.name; renderSessions();
  }

  sess.messages.push({ role:'user', content:text }); saveSessions();
  appendMessageEl('user', text);
  document.getElementById('user-input').value = ''; document.getElementById('user-input').style.height = 'auto';
  setStreaming(true);

  const aiWrap = appendMessageEl('ai',''); const bub = aiWrap.querySelector('.bubble-ai'); bub.classList.add('cursor-blink');

  try {
    // Build system prompt
    let sys = settings.sysPrompt || 'ä½ æ˜¯ä¸€ä¸ªæœ‰å¸®åŠ©çš„ AI åŠ©æ‰‹ã€‚';
    const mm = document.getElementById('manual-memory').value.trim();
    if (mm) sys += '\n\nå…³äºç”¨æˆ·ï¼š\n' + mm;
    if (autoMemories.length) sys += '\n\nä»å¯¹è¯ä¸­è®°ä½çš„ï¼š\n' + autoMemories.map(m => '- ' + m.text).join('\n');

    // Trim history to context limit
    const allMsgs = sess.messages;
    const limit = settings.contextLimit || 20;
    const trimmed = limit >= 9999 ? allMsgs : allMsgs.slice(-limit);

    const payload = {
      model: settings.model, stream: true,
      messages: [{ role:'system', content:sys }, ...trimmed]
    };
    const temp = parseFloat(settings.temperature); if (!isNaN(temp)) payload.temperature = temp;

    const isR = payload.model.startsWith('o1') || payload.model.startsWith('o3');
    if (isR) { delete payload.temperature; payload.stream = false; }

    const base = (settings.baseUrl || 'https://api.openai.com/v1').replace(/\/$/,'');
    abortCtrl = new AbortController();

    const inputStr = JSON.stringify(payload.messages);
    const resp = await fetch(`${base}/chat/completions`, {
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':`Bearer ${settings.apiKey}`},
      body: JSON.stringify(payload), signal: abortCtrl.signal
    });
    if (!resp.ok) { const e = await resp.json().catch(()=>({})); throw new Error(e.error?.message || resp.statusText); }

    let full = '';
    if (isR) {
      const d = await resp.json(); full = d.choices[0].message.content; bub.innerHTML = renderMarkdown(full);
    } else {
      const reader = resp.body.getReader(); const dec = new TextDecoder();
      while (true) {
        const { done, value } = await reader.read(); if (done) break;
        const lines = dec.decode(value,{stream:true}).split('\n').filter(l=>l.startsWith('data: '));
        for (const line of lines) {
          const d = line.slice(6).trim(); if (d==='[DONE]') break;
          try { const delta = JSON.parse(d).choices?.[0]?.delta?.content; if (delta) { full+=delta; bub.innerHTML=renderMarkdown(full); scrollToBottom(); } } catch {}
        }
      }
    }

    bub.classList.remove('cursor-blink');
    sess.messages.push({ role:'assistant', content:full });

    // Update cost
    const cost = estimateCost(inputStr, full);
    sessionCost += cost;
    sess.cost = sessionCost;
    updateCostBadge();
    saveSessions();

  } catch(err) {
    bub.classList.remove('cursor-blink');
    if (err.name==='AbortError') { if (!bub.textContent.trim()) bub.textContent='(å·²åœæ­¢)'; }
    else { bub.textContent='å‡ºé”™å•¦ï¼š'+err.message; bub.style.color='var(--red)'; showToast(err.message.slice(0,80),'error'); }
  } finally { setStreaming(false); abortCtrl=null; scrollToBottom(); }
}

function stopGeneration() { abortCtrl?.abort(); }
function setStreaming(v) {
  isStreaming=v; document.getElementById('send-btn').disabled=v;
  document.getElementById('stop-btn').classList.toggle('show',v);
  document.getElementById('user-input').disabled=v;
}

// â”€â”€â”€ Memory â”€â”€â”€
function loadMemories() {
  const m = document.getElementById('manual-memory'); m.value = localStorage.getItem(K.manualMem)||'';
  m.addEventListener('input', () => localStorage.setItem(K.manualMem, m.value));
  const a = localStorage.getItem(K.autoMem); autoMemories = a ? JSON.parse(a) : [];
}
function saveAutoMemories() { localStorage.setItem(K.autoMem, JSON.stringify(autoMemories)); }

function renderAutoMemories() {
  const el = document.getElementById('auto-memories');
  document.getElementById('mem-total').textContent = autoMemories.length;
  document.getElementById('mem-tokens').textContent = Math.ceil(autoMemories.map(m=>m.text).join(' ').length / 3.5);
  document.getElementById('mem-count-display').textContent = autoMemories.length;
  if (!autoMemories.length) { el.innerHTML='<div class="mem-empty">è¿˜æ²¡æœ‰è®°å¿†å‘¢<br/>å¯¹è¯ä¸€ä¼šå„¿è®© AI å¸®ä½ æå–å§ ğŸŒ±</div>'; return; }
  el.innerHTML = autoMemories.map((m,i) => `
    <div class="mem-item">
      <span class="mem-item-text">${esc(m.text)}</span>
      <button class="mem-item-del" onclick="deleteMemory(${i})">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>`).join('');
}
function deleteMemory(i) { autoMemories.splice(i,1); saveAutoMemories(); renderAutoMemories(); }
function clearAutoMemories() {
  if (!confirm('ç¡®å®šæ¸…ç©ºå…¨éƒ¨ AI è®°å¿†å—ï¼Ÿ')) return;
  autoMemories=[]; saveAutoMemories(); renderAutoMemories();
}

async function extractMemories() {
  const sess = currentSession(); if (!sess?.messages.length) { showToast('å½“å‰å¯¹è¯æ²¡æœ‰å†…å®¹å“¦'); return; }
  if (!settings.apiKey) { openSettings(); return; }
  const btn = document.getElementById('extract-btn'); btn.disabled=true; btn.textContent='æå–ä¸­â€¦âœ¨';
  try {
    const base = (settings.baseUrl||'https://api.openai.com/v1').replace(/\/$/,'');
    const conv = sess.messages.slice(-40).map(m=>`${m.role==='user'?'ç”¨æˆ·':'AI'}: ${m.content}`).join('\n');
    const resp = await fetch(`${base}/chat/completions`, { method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${settings.apiKey}`}, body: JSON.stringify({ model:'gpt-4o-mini', temperature:0.3, messages:[{role:'system',content:'ä»å¯¹è¯ä¸­æå–å…³äºç”¨æˆ·çš„é‡è¦ä¿¡æ¯ï¼ˆåå¥½ã€ä¹ æƒ¯ã€èº«ä»½ã€ç›®æ ‡ç­‰ï¼‰ï¼Œè¿”å›çº¯ JSON æ•°ç»„ï¼Œæ ¼å¼ï¼š["äº‹å®1","äº‹å®2"]ã€‚æ²¡æœ‰åˆ™è¿”å› []ã€‚ä¸è¦åŒ…å«å…¶ä»–æ–‡å­—ã€‚'},{role:'user',content:'æå–ç”¨æˆ·è®°å¿†ï¼š\n\n'+conv}] }) });
    const data = await resp.json();
    const items = JSON.parse((data.choices?.[0]?.message?.content||'[]').replace(/```json|```/g,'').trim());
    if (!items.length) { showToast('æ²¡æœ‰å‘ç°æ–°è®°å¿†å‘¢ ğŸ¤”'); return; }
    const existing = new Set(autoMemories.map(m=>m.text)); let added=0;
    items.forEach(text => { if (!existing.has(text)) { autoMemories.unshift({id:Date.now()+Math.random(),text}); added++; } });
    saveAutoMemories(); renderAutoMemories(); showToast(`è®°ä½äº† ${added} ä»¶äº‹ ğŸŒ¸`);
  } catch(err) { showToast('æå–å¤±è´¥ï¼š'+err.message,'error'); }
  finally { btn.disabled=false; btn.textContent='âœ¨ ä»å½“å‰å¯¹è¯æå–è®°å¿†'; }
}

// â”€â”€â”€ Compress memories â”€â”€â”€
async function compressMemories() {
  if (autoMemories.length < 3) { showToast('è®°å¿†å¤ªå°‘äº†ï¼Œä¸éœ€è¦å‹ç¼©ï½'); return; }
  if (!settings.apiKey) { openSettings(); return; }
  const btn = document.getElementById('compress-btn'); btn.disabled=true; btn.textContent='å‹ç¼©ä¸­â€¦ğŸ—œï¸';
  try {
    const base = (settings.baseUrl||'https://api.openai.com/v1').replace(/\/$/,'');
    const memText = autoMemories.map((m,i) => `${i+1}. ${m.text}`).join('\n');
    const resp = await fetch(`${base}/chat/completions`, { method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${settings.apiKey}`}, body: JSON.stringify({ model:'gpt-4o-mini', temperature:0.2, messages:[{role:'system',content:'ä½ æ˜¯ä¸€ä¸ªè®°å¿†æ•´ç†åŠ©æ‰‹ã€‚æŠŠä¸‹é¢çš„è®°å¿†åˆ—è¡¨åˆå¹¶ç²¾ç®€ï¼šæŠŠç›¸ä¼¼çš„åˆå¹¶æˆä¸€æ¡ï¼Œåˆ æ‰ä¸é‡è¦çš„ç»†èŠ‚ï¼Œä¿ç•™æ‰€æœ‰å…³é”®ä¿¡æ¯ã€‚è¿”å›çº¯ JSON æ•°ç»„ï¼Œæ ¼å¼ï¼š["ç²¾ç®€åçš„è®°å¿†1","ç²¾ç®€åçš„è®°å¿†2"]ã€‚ä¸è¦åŒ…å«å…¶ä»–æ–‡å­—ã€‚'},{role:'user',content:'è¯·å‹ç¼©ç²¾ç®€è¿™äº›è®°å¿†ï¼š\n\n'+memText}] }) });
    const data = await resp.json();
    const items = JSON.parse((data.choices?.[0]?.message?.content||'[]').replace(/```json|```/g,'').trim());
    if (!items.length) { showToast('å‹ç¼©å¤±è´¥äº†ï¼Œè¯·é‡è¯•'); return; }
    const before = autoMemories.length;
    autoMemories = items.map(text => ({ id: Date.now()+Math.random(), text }));
    saveAutoMemories(); renderAutoMemories();
    showToast(`ä» ${before} æ¡å‹ç¼©åˆ° ${items.length} æ¡ ğŸ‰`);
  } catch(err) { showToast('å‹ç¼©å¤±è´¥ï¼š'+err.message,'error'); }
  finally { btn.disabled=false; btn.textContent='ğŸ—œï¸ å‹ç¼©ç²¾ç®€è®°å¿†åº“'; }
}

// â”€â”€â”€ Export/Import memories â”€â”€â”€
function exportMemories() {
  if (!autoMemories.length) { showToast('è¿˜æ²¡æœ‰è®°å¿†å¯ä»¥å¤‡ä»½å“¦'); return; }
  const data = { version:1, exportedAt: new Date().toISOString(), manualNotes: document.getElementById('manual-memory').value, memories: autoMemories };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type:'application/json' });
  const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url;
  a.download=`è®°å¿†åº“å¤‡ä»½_${new Date().toLocaleDateString('zh-CN').replace(/\//g,'-')}.json`;
  a.click(); URL.revokeObjectURL(url); showToast('è®°å¿†åº“å·²å¤‡ä»½ ğŸ’¾');
}
function importMemories(e) {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const data = JSON.parse(ev.target.result);
      if (data.memories) {
        const before = autoMemories.length;
        const existing = new Set(autoMemories.map(m=>m.text)); let added=0;
        data.memories.forEach(m => { if (!existing.has(m.text)) { autoMemories.push(m); added++; } });
        if (data.manualNotes && !document.getElementById('manual-memory').value.trim()) {
          document.getElementById('manual-memory').value = data.manualNotes;
          localStorage.setItem(K.manualMem, data.manualNotes);
        }
        saveAutoMemories(); renderAutoMemories();
        showToast(`å¯¼å…¥äº† ${added} æ¡æ–°è®°å¿† ğŸŒ¸`);
      }
    } catch { showToast('æ–‡ä»¶æ ¼å¼ä¸å¯¹å“¦', 'error'); }
    e.target.value = '';
  };
  reader.readAsText(file);
}

// â”€â”€â”€ Memory tabs â”€â”€â”€
function switchMemTab(tab) {
  document.querySelectorAll('.mem-tab').forEach((t,i) => t.classList.toggle('active', ['manual','auto'][i]===tab));
  document.querySelectorAll('.mem-pane').forEach((p,i) => p.classList.toggle('active', ['pane-manual','pane-auto'][i]===`pane-${tab}`));
}

function toggleMemory() {
  document.getElementById('memory-panel').classList.toggle('open');
  document.getElementById('mem-toggle').classList.toggle('active');
}

// â”€â”€â”€ Export chat â”€â”€â”€
function exportChat() {
  const sess = currentSession(); if (!sess?.messages.length) { showToast('å½“å‰å¯¹è¯æ²¡æœ‰å†…å®¹å“¦'); return; }
  const lines = [`# ${sess.name}`, `å¯¼å‡ºæ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}`, `é¢„ä¼°èŠ±è´¹ï¼š$${(sess.cost||0).toFixed(4)}`, ''];
  sess.messages.forEach(m => { if (m.role==='user') lines.push(`**ä½ ï¼š** ${m.content}`); else if (m.role==='assistant') lines.push(`**AIï¼š** ${m.content}`); lines.push(''); });
  const blob = new Blob([lines.join('\n')], { type:'text/markdown;charset=utf-8' });
  const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url;
  a.download=`${sess.name.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g,'_')}_${Date.now()}.md`; a.click(); URL.revokeObjectURL(url);
  showToast('å¯¼å‡ºæˆåŠŸ ğŸ’¾');
}

// â”€â”€â”€ Utils â”€â”€â”€
function scrollToBottom() { const el=document.getElementById('messages'); el.scrollTop=el.scrollHeight; }
let toastTimer;
function showToast(msg,type='') {
  const t=document.getElementById('toast'); t.textContent=msg;
  t.className='toast show'+(type==='error'?' error':'');
  clearTimeout(toastTimer); toastTimer=setTimeout(()=>t.classList.remove('show'),3200);
}

const ui = document.getElementById('user-input');
ui.addEventListener('input', ()=>{ ui.style.height='auto'; ui.style.height=Math.min(ui.scrollHeight,180)+'px'; });
ui.addEventListener('keydown', e=>{ if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();} });

// â”€â”€â”€ Mobile sidebar toggle â”€â”€â”€
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebar-overlay');
  const isOpen = sidebar.classList.contains('open');
  
  if (isOpen) {
    sidebar.classList.remove('open');
    overlay.classList.remove('show');
  } else {
    sidebar.classList.add('open');
    overlay.classList.add('show');
  }
}

init();
</script>
</body>
</html>
